<!DOCTYPE html>
<html>
<body>

<h1>Roguelike Showdown</h1>

<button onclick="getChoices()">get choices</button>
<br>
<pre id="choice1"></pre>
<pre id="choice2"></pre>
<pre id="choice3"></pre>


<script>

const STATS = ['hp', 'atk', 'def', 'spa', 'spd', 'spe'];
// 1st number is index of stat raised, 2nd number is index of stat lowered
const NATURES = {Hardy: [1,1], Lonely: [1,2], Adamant: [1,3], Naughty: [1,4], Brave: [1,5], 
Bold: [2,1], Docile: [2,2], Impish: [2,3], Lax: [2,4], Relaxed: [2,5], 
Modest: [3,1], Mild: [3,2], Bashful: [3,3], Rash: [3,4], Quiet: [3,5], 
Calm: [4,1], Gentle: [4,2], Careful: [4,3], Quirky: [4,4], Sassy: [4,5], 
Timid: [5,1], Hasty: [5,2], Jolly: [5,3], Naive: [5,4], Serious: [5,5]};

let pokedex;
loadPokedex();
let learnsets;
loadLearnsets();
let moves;
loadMoves();

function loadPokedex() {
  const xhttp = new XMLHttpRequest();
  xhttp.onload = function() {
    pokedex = JSON.parse(this.responseText);
  }
  xhttp.open("GET", "pokedex.json");
  xhttp.send();
}
function loadLearnsets() {
  const xhttp = new XMLHttpRequest();
  xhttp.onload = function() {
    learnsets = JSON.parse(this.responseText);
  }
  xhttp.open("GET", "learnsets.json");
  xhttp.send();
}
function loadMoves() {
  const xhttp = new XMLHttpRequest();
  xhttp.onload = function() {
    moves = JSON.parse(this.responseText);
  }
  xhttp.open("GET", "moves.json");
  xhttp.send();
}

function getChoices() {
  document.getElementById("choice1").textContent = randomPokemon();
  document.getElementById("choice2").textContent = randomPokemon();
  document.getElementById("choice3").textContent = randomPokemon();
  
  // // useful for testing
  // for (const pokemonId of Object.keys(pokedex)) {
  //   console.log(randomOfSpecies(pokemonId));
  // }
}

function randomPokemon() {
  let pokemonId = 'charizardgmax';
  while (pokedex[pokemonId]?.forme === 'Gmax')
    pokemonId = randomKey(pokedex);
  return randomOfSpecies(pokemonId);
}

function randomOfSpecies(pokemonId) {
  console.log(pokemonId)
  const pokemon = pokedex[pokemonId];

  let out = pokemon.name;
  if (pokemon.requiredItem)
    out += ' @ ' + pokemon.requiredItem;
  out += '\nAbility: ' + randomProperty(pokemon.abilities);
  out += '\nTera Type: ' + randomElement(pokemon.types);
  out += '\nEVs: 1 HP';
  let nature = randomKey(NATURES);
  out += '\n' + nature + ' Nature';
  // out += '\nIVs: ';
  // for (const stat of STATS)
  //   out += randomInt(31) + ' ' + stat + ' / ';
  // out = out.slice(0, -3);

  // add moveset
  if (pokemonId.substring(0, 8) === 'pokestar') {
    const moveset = randomElement(learnsets[pokemonId].eventData).moves;
    for (const move of moveset)
      out += '\n- ' + moves[move].name;
  } else {
    let learnsetData = learnsets[pokemonId];
    if (!learnsetData?.learnset)
      learnsetData = learnsets[pokemon.baseSpecies.toLowerCase()];
    
    let possibleMoves = Object.keys(learnsetData.learnset);
    for (let i = 0; i < 4 && possibleMoves.length > 0; i++) {
      const moveIndex = randomInt(possibleMoves.length);
      out += '\n- ' + moves[possibleMoves[moveIndex]].name;
      possibleMoves.splice(moveIndex, 1);
    }
  }

  let statTotal = 0;
  out += '\n\nSTATS: '
  for (const stat of STATS) {
    let statNum;
    if (stat === 'hp')
      statNum = Math.floor(2 * pokemon.baseStats[stat] + 31) + 100 + 10;
    else {
      let multiplier = 1;
      if (STATS[NATURES[nature][0]] === stat)
        multiplier += .2;
      if (STATS[NATURES[nature][1]] === stat)
        multiplier -= .2;
      statNum = Math.floor((Math.floor(2 * pokemon.baseStats[stat] + 31) + 5) * multiplier);
    }
    statTotal += statNum;
    out += statNum + ' / ';
  }
  out = out.slice(0, -2);
  out += '(' + statTotal + ')';

  return out;
}

function randomProperty(obj) {
  return obj[randomKey(obj)];
}

function randomElement(array) {
  return array[randomInt(array.length)];
}
function randomKey(obj) {
  const keys = Object.keys(obj);
  return keys[randomInt(keys.length)];
}

function randomInt(max) {
  return Math.floor(Math.random() * max); 
}

</script>

</body>
</html>
