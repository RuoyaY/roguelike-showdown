<!DOCTYPE html>
<html>

<head>
<style>
pre {
  background-color: whitesmoke;
  background-repeat: no-repeat;
  background-position-x: right;
  background-position-y: center;
}
</style>
</head>

<body>

<h1>Roguelike Showdown</h1>

<button onclick="getChoices()">get choices</button>
<br>
<div id="choices"></div>


<script>

const STATS = ['HP', 'Atk', 'Def', 'SpA', 'SpD', 'Spe'];
// 1st number is index of stat raised, 2nd number is index of stat lowered
const NATURES = {Hardy: [1,1], Lonely: [1,2], Adamant: [1,3], Naughty: [1,4], Brave: [1,5], 
Bold: [2,1], Docile: [2,2], Impish: [2,3], Lax: [2,4], Relaxed: [2,5], 
Modest: [3,1], Mild: [3,2], Bashful: [3,3], Rash: [3,4], Quiet: [3,5], 
Calm: [4,1], Gentle: [4,2], Careful: [4,3], Quirky: [4,4], Sassy: [4,5], 
Timid: [5,1], Hasty: [5,2], Jolly: [5,3], Naive: [5,4], Serious: [5,5]};
const TYPES = ['Normal', 'Fire', 'Water', 'Grass', 'Electric',
  'Ice', 'Fighting', 'Poison', 'Ground', 'Flying',
  'Psychic', 'Bug', 'Rock', 'Ghost', 'Dark', 
  'Dragon', 'Steel', 'Fairy'];

const STAT_TOTAL_GOAL = 600;

// for testing/studying purposes
let levelStats = '';

let pokedex;
loadPokedex();
let learnsets;
loadLearnsets();
let moves;
loadMoves();

function loadPokedex() {
  const xhttp = new XMLHttpRequest();
  xhttp.onload = function() {
    pokedex = JSON.parse(this.responseText);
  }
  xhttp.open("GET", "pokedex.json");
  xhttp.send();
}
function loadLearnsets() {
  const xhttp = new XMLHttpRequest();
  xhttp.onload = function() {
    learnsets = JSON.parse(this.responseText);
  }
  xhttp.open("GET", "learnsets.json");
  xhttp.send();
}
function loadMoves() {
  const xhttp = new XMLHttpRequest();
  xhttp.onload = function() {
    moves = JSON.parse(this.responseText);
  }
  xhttp.open("GET", "moves.json");
  xhttp.send();
}

function getChoices() {
  const choicesDiv = document.getElementById('choices');
  choicesDiv.prepend(document.createElement('hr'));
  addRandomPokemon(choicesDiv);
  addRandomPokemon(choicesDiv);
  addRandomPokemon(choicesDiv);
  
  // // useful for testing
  // for (const pokemonId of Object.keys(pokedex)) {
  //   randomOfSpecies(pokemonId);
  // }
  // console.log(levelStats);
}

function addRandomPokemon(choicesDiv) {
  let pokemonId = randomKey(pokedex);
  while (pokedex[pokemonId]?.forme === 'Gmax')
    pokemonId = randomKey(pokedex);
  
  const pre = document.createElement('pre');
  pre.appendChild(document.createTextNode(randomOfSpecies(pokemonId)));
  pre.style.backgroundImage = getImageURL(pokemonId);
  choicesDiv.prepend(pre);
}

function getImageURL(pokemonId) {
  return 'url(https://play.pokemonshowdown.com/sprites/dex/' + pokedex[pokemonId].name.toLowerCase().replace(/\s+/g, '') + '.png)';
}

function randomOfSpecies(pokemonId) {
  const pokemon = pokedex[pokemonId];

  let out = pokemon.name;
  if (pokemon.requiredItem)
    out += ' @ ' + pokemon.requiredItem;
  out += '\nAbility: ' + randomProperty(pokemon.abilities);

  let bst = 0;
  for (const stat of STATS)
    bst += pokemon.baseStats[stat.toLowerCase()];
  const level = Math.round(100 * (STAT_TOTAL_GOAL - 10 - 5*5) / (2 * bst + 100 + 31*6));
  out += '\nLevel: ' + level;
  levelStats += level + ', ';

  out += '\nTera Type: ' + randomElement(TYPES);
  out += '\nEVs: 1 HP';

  // add moveset
  if (pokemonId.substring(0, 8) === 'pokestar') {
    const moveset = randomElement(learnsets[pokemonId].eventData).moves;
    for (const move of moveset)
      out += '\n- ' + moves[move].name;
  } else {
    let learnsetData = learnsets[pokemonId];

    if (!learnsetData?.learnset)
      learnsetData = learnsets[pokemon.baseSpecies.toLowerCase()];

    let possibleMoves = Object.keys(learnsetData.learnset);
    if (possibleMoves.length < 4 && pokemon.baseSpecies) {
      let baseSpeciesLearnset = learnsets[pokemon.baseSpecies.toLowerCase()].learnset;
      possibleMoves.push(...Object.keys(baseSpeciesLearnset));
    }
    
    for (let i = 0; i < 4 && possibleMoves.length > 0; i++) {
      const moveIndex = randomInt(possibleMoves.length);
      out += '\n- ' + moves[possibleMoves[moveIndex]].name;
      possibleMoves.splice(moveIndex, 1);
    }
  }

  out += '\n\nSTATS: '
  for (const stat of STATS) {
    let statNum;
    if (stat === 'HP') {
      if (pokemonId === 'shedinja')
        statNum = 1;
      else
        statNum = Math.floor((2*pokemon.baseStats[stat.toLowerCase()] + 31) * level/100) + level + 10;
    } else {
      statNum = Math.floor((2*pokemon.baseStats[stat.toLowerCase()] + 31) * level/100) + 5;
    }
    out += statNum + ' ' + stat + ' / ';
  }
  out = out.slice(0, -2);

  return out;
}

function randomProperty(obj) {
  return obj[randomKey(obj)];
}

function randomElement(array) {
  return array[randomInt(array.length)];
}
function randomKey(obj) {
  const keys = Object.keys(obj);
  return keys[randomInt(keys.length)];
}

function randomInt(max) {
  return Math.floor(Math.random() * max); 
}

</script>

</body>
</html>
